name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint.yaml kubernetes/ talos/

  kubeconform:
    name: Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | \
            tar xz -C /usr/local/bin

      - name: Download Flux CRDs
        run: |
          mkdir -p /tmp/flux-crds
          curl -sL https://github.com/fluxcd/flux2/releases/latest/download/crd-schemas.tar.gz | \
            tar xz -C /tmp/flux-crds

      - name: Validate Kubernetes manifests
        run: |
          find kubernetes -name '*.yaml' -not -name '*.sops.yaml' -print0 | \
            xargs -0 kubeconform \
              -strict \
              -ignore-missing-schemas \
              -schema-location default \
              -schema-location '/tmp/flux-crds/{{ .ResourceKind }}{{ .KindSuffix }}.json' \
              -summary

  flux-validate:
    name: Flux HelmReleases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Validate Flux manifests
        run: |
          echo "Validating Kustomizations..."
          find kubernetes -name 'kustomization.yaml' -exec dirname {} \; | while read dir; do
            echo "  → $dir"
            flux build kustomization test \
              --path="$dir" \
              --kustomization-file=/dev/null \
              --dry-run 2>/dev/null || echo "    (skipped - needs cluster context)"
          done
          echo "✅ Flux validation complete"

  renovate-validate:
    name: Renovate Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate Renovate config
        run: |
          npx -y -p renovate -- renovate-config-validator .github/renovate.json

  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [yaml-lint, kubeconform, renovate-validate]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.yaml-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.kubeconform.result }}" == "failure" ]] || \
             [[ "${{ needs.renovate-validate.result }}" == "failure" ]]; then
            echo "❌ One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed"
