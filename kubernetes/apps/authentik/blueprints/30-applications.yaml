apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprint-30-applications
  namespace: authentik
data:
  applications.yaml: |
    version: 1
    metadata:
      name: Homelab Applications
    entries:
      # ===================
      # Policy: require-homelab-admins
      # ===================
      - model: authentik_policies_expression.expressionpolicy
        id: policy-require-admins
        state: present
        identifiers:
          name: require-homelab-admins
        attrs:
          expression: |
            return ak_is_group_member(request.user, name="homelab-admins")

      # ===================
      # Hubble (admins only)
      # ===================
      - model: authentik_core.application
        id: app-hubble
        state: present
        identifiers:
          slug: hubble
        attrs:
          name: Hubble
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Hubble Proxy]]
          meta_launch_url: https://hubble.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-hubble-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, hubble]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      # ===================
      # Longhorn (admins only)
      # ===================
      - model: authentik_core.application
        id: app-longhorn
        state: present
        identifiers:
          slug: longhorn
        attrs:
          name: Longhorn
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Longhorn Proxy]]
          meta_launch_url: https://longhorn.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-longhorn-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, longhorn]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      # ===================
      # Traefik Dashboard (admins only)
      # ===================
      - model: authentik_core.application
        id: app-traefik
        state: present
        identifiers:
          slug: traefik
        attrs:
          name: Traefik Dashboard
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Traefik Proxy]]
          meta_launch_url: https://traefik.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-traefik-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, traefik]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      # ===================
      # AdGuard (admins only)
      # ===================
      - model: authentik_core.application
        id: app-adguard
        state: present
        identifiers:
          slug: adguard
        attrs:
          name: AdGuard Home
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, AdGuard Proxy]]
          meta_launch_url: https://adguard.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-adguard-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, adguard]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      # ===================
      # Homarr (open to all authenticated users)
      # ===================
      - model: authentik_core.application
        id: app-homarr
        state: present
        identifiers:
          slug: homarr
        attrs:
          name: Homarr
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Homarr Proxy]]
          meta_launch_url: https://homarr.merry.home.arpa
          policy_engine_mode: any

      # ===================
      # Grafana (admins only, OIDC)
      # ===================
      - model: authentik_core.application
        id: app-grafana
        state: present
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, Grafana OIDC]]
          meta_launch_url: https://grafana.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-grafana-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, grafana]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30
