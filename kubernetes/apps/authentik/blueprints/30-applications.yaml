apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprint-applications
  namespace: authentik
data:
  applications.yaml: |
    version: 1
    metadata:
      name: Homelab Applications
    entries:
      - model: authentik_policies_expression.expressionpolicy
        id: policy-require-admins
        state: present
        identifiers:
          name: require-homelab-admins
        attrs:
          expression: |
            return ak_is_group_member(request.user, name="homelab-admins")

      - model: authentik_core.application
        id: app-longhorn
        state: present
        identifiers:
          slug: longhorn
        attrs:
          name: Longhorn
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Homelab Forward Auth]]
          meta_launch_url: https://longhorn.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-longhorn-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, longhorn]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      - model: authentik_core.application
        id: app-traefik
        state: present
        identifiers:
          slug: traefik
        attrs:
          name: Traefik Dashboard
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Homelab Forward Auth]]
          meta_launch_url: https://traefik.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-traefik-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, traefik]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      - model: authentik_core.application
        id: app-adguard
        state: present
        identifiers:
          slug: adguard
        attrs:
          name: AdGuard Home
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Homelab Forward Auth]]
          meta_launch_url: https://adguard.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-adguard-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, adguard]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      - model: authentik_core.application
        id: app-homepage
        state: present
        identifiers:
          slug: homepage
        attrs:
          name: Homepage
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Homelab Forward Auth]]
          meta_launch_url: https://homepage.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-homepage-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, homepage]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      - model: authentik_core.application
        id: app-homarr
        state: present
        identifiers:
          slug: homarr
        attrs:
          name: Homarr
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, Homelab Forward Auth]]
          meta_launch_url: https://homarr.merry.home.arpa
          policy_engine_mode: any

      - model: authentik_core.application
        id: app-grafana
        state: present
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, Grafana OIDC]]
          meta_launch_url: https://grafana.merry.home.arpa
          policy_engine_mode: all

      - model: authentik_policies.policybinding
        id: binding-grafana-admin
        state: present
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, grafana]]
          policy: !Find [authentik_policies_expression.expressionpolicy, [name, require-homelab-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30
