apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: frigate
  namespace: home-automation
spec:
  interval: 30m
  timeout: 15m

  chart:
    spec:
      chart: frigate
      version: "7.8.0"
      sourceRef:
        kind: HelmRepository
        name: blakeshome
        namespace: flux-system
      interval: 1h

  dependsOn:
    - name: cilium
      namespace: kube-system
    - name: longhorn
      namespace: longhorn-system

  install:
    crds: CreateReplace
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  uninstall:
    keepHistory: false

  values:
    image:
      # renovate: datasource=docker depName=ghcr.io/blakeblackshear/frigate
      tag: "0.16.3"

    strategyType: Recreate

    podAnnotations:
      reloader.stakater.com/auto: "true"

    securityContext:
      allowPrivilegeEscalation: false

    shmSize: 1Gi

    env:
      TZ: ${TIMEZONE}
      LIBVA_DRIVER_NAME: iHD

    resources:
      requests:
        cpu: 500m
        memory: 1Gi
        gpu.intel.com/i915: "1"
      limits:
        cpu: 4000m
        memory: 4Gi
        gpu.intel.com/i915: "1"

    persistence:
      config:
        enabled: true
        storageClass: ${DEFAULT_STORAGE_CLASS}
        size: 1Gi
        skipuninstall: true
      media:
        enabled: true
        storageClass: ${DEFAULT_STORAGE_CLASS}
        size: 100Gi
        skipuninstall: true

    probes:
      startup:
        enabled: true
        failureThreshold: 30
        periodSeconds: 10

    config: |
      mqtt:
        host: mosquitto.home-automation.svc.cluster.local
        port: 1883
        topic_prefix: frigate
        client_id: frigate

      detectors:
        ov:
          type: openvino
          device: GPU

      model:
        width: 300
        height: 300
        input_tensor: nhwc
        input_pixel_format: bgr
        path: /openvino-model/ssdlite_mobilenet_v2.xml
        labelmap_path: /openvino-model/coco_91cl_bkgr.txt

      ffmpeg:
        hwaccel_args: preset-vaapi

      cameras:
        # TODO: Replace with actual RTSP URLs
        camera_1:
          enabled: true
          ffmpeg:
            inputs:
              - path: rtsp://USER:PASS@CAMERA_1_IP:554/stream1
                roles:
                  - detect
                  - record
          detect:
            width: 1280
            height: 720
            fps: 5
        camera_2:
          enabled: true
          ffmpeg:
            inputs:
              - path: rtsp://USER:PASS@CAMERA_2_IP:554/stream1
                roles:
                  - detect
                  - record
          detect:
            width: 1280
            height: 720
            fps: 5

      record:
        enabled: true
        retain:
          days: 7
          mode: motion
        events:
          retain:
            default: 14
            mode: active_objects

      snapshots:
        enabled: true
        retain:
          default: 14

      objects:
        track:
          - person
          - car
          - dog
          - cat
