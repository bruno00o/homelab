---
apiVersion: cilium.io/v2
kind: CiliumEnvoyConfig
metadata:
  name: gateway-ext-authz
  namespace: kube-system
spec:
  backendServices:
    - name: hubble-ui
      namespace: kube-system
    - name: longhorn-frontend
      namespace: longhorn-system
    - name: adguard-web
      namespace: adguard
    - name: homarr
      namespace: homarr
  resources:
    - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: authentik-ext-authz
      type: STRICT_DNS
      connect_timeout: 5s
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: authentik-ext-authz
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: authentik-server.authentik.svc.cluster.local
                      port_value: 80
    - "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
      stat_prefix: gateway_ext_authz
      http_filters:
        - name: envoy.filters.http.ext_authz
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
            transport_api_version: V3
            http_service:
              server_uri:
                uri: authentik-server.authentik.svc.cluster.local
                cluster: authentik-ext-authz
                timeout: 10s
              path_prefix: /outpost.goauthentik.io/auth/traefik
              authorization_request:
                allowed_headers:
                  patterns:
                    - exact: cookie
                    - exact: authorization
                headers_to_add:
                  - key: X-Forwarded-Proto
                    value: https
              authorization_response:
                allowed_upstream_headers:
                  patterns:
                    - exact: x-authentik-username
                    - exact: x-authentik-groups
                    - exact: x-authentik-email
                    - exact: x-authentik-name
                    - exact: x-authentik-uid
            failure_mode_allow: false
        - name: envoy.filters.http.router
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
