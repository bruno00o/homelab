---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: garage-init
  namespace: garage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: garage-init
  namespace: garage
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/exec"]
    verbs: ["get", "list", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: garage-init
  namespace: garage
subjects:
  - kind: ServiceAccount
    name: garage-init
    namespace: garage
roleRef:
  kind: Role
  name: garage-init
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: garage-init-secrets
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: garage-init-secrets
subjects:
  - kind: ServiceAccount
    name: garage-init
    namespace: garage
roleRef:
  kind: ClusterRole
  name: garage-init-secrets
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: garage-init
  namespace: garage
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: garage-init
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: garage-init
          image: bitnami/kubectl:latest
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          command:
            - /bin/sh
            - -c
            - |
              set -e

              GARAGE_POD="garage-0"

              # Wait for Garage pod to be ready
              echo "Waiting for Garage pod..."
              kubectl wait --for=condition=ready pod/$GARAGE_POD -n garage --timeout=300s

              # Wait for layout to be configured (max 5 min)
              echo "Checking layout..."
              LAYOUT_READY=false
              for i in $(seq 1 30); do
                if kubectl exec -n garage $GARAGE_POD -c garage -- ./garage layout show 2>/dev/null | grep -q "Current cluster layout version: [1-9]"; then
                  echo "Layout is configured"
                  LAYOUT_READY=true
                  break
                fi
                echo "Layout not configured yet, waiting... ($i/30)"
                sleep 10
              done

              if [ "$LAYOUT_READY" = "false" ]; then
                echo "ERROR: Layout not configured after 5 minutes."
                echo "Configure layout manually, then delete this job to re-run:"
                echo "  kubectl delete job garage-init -n garage"
                exit 1
              fi

              # Create bucket if not exists
              if ! kubectl exec -n garage $GARAGE_POD -c garage -- ./garage bucket list 2>/dev/null | grep -q "cnpg-backups"; then
                echo "Creating bucket cnpg-backups..."
                kubectl exec -n garage $GARAGE_POD -c garage -- ./garage bucket create cnpg-backups
              else
                echo "Bucket cnpg-backups already exists"
              fi

              # Create key if not exists
              if ! kubectl exec -n garage $GARAGE_POD -c garage -- ./garage key list 2>/dev/null | grep -q "cnpg-backup-key"; then
                echo "Creating key cnpg-backup-key..."
                kubectl exec -n garage $GARAGE_POD -c garage -- ./garage key create cnpg-backup-key
                kubectl exec -n garage $GARAGE_POD -c garage -- ./garage bucket allow cnpg-backups --read --write --key cnpg-backup-key
              else
                echo "Key cnpg-backup-key already exists"
              fi

              # Get key credentials (with --show-secret to get the actual secret)
              echo "=== Extracting Key Credentials ==="
              KEY_INFO=$(kubectl exec -n garage $GARAGE_POD -c garage -- ./garage key info cnpg-backup-key --show-secret)
              # Don't echo full output to avoid leaking secret in logs

              ACCESS_KEY_ID=$(echo "$KEY_INFO" | grep "Key ID:" | awk '{print $3}')
              ACCESS_SECRET_KEY=$(echo "$KEY_INFO" | grep "Secret key:" | awk '{print $3}')

              if [ -z "$ACCESS_KEY_ID" ] || [ -z "$ACCESS_SECRET_KEY" ]; then
                echo "ERROR: Failed to extract key credentials"
                exit 1
              fi

              echo "Access Key ID: $ACCESS_KEY_ID"
              echo "Secret Key: [REDACTED]"

              # Create/update secret in authentik namespace
              echo "=== Creating S3 credentials secret in authentik namespace ==="

              # Check if namespace exists
              if ! kubectl get namespace authentik >/dev/null 2>&1; then
                echo "Namespace authentik does not exist yet, creating..."
                kubectl create namespace authentik
              fi

              # Create or update the secret
              kubectl create secret generic cnpg-s3-credentials \
                --namespace=authentik \
                --from-literal=ACCESS_KEY_ID="$ACCESS_KEY_ID" \
                --from-literal=ACCESS_SECRET_KEY="$ACCESS_SECRET_KEY" \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "=== Secret cnpg-s3-credentials created/updated in authentik namespace ==="
              echo "Garage init completed successfully!"
